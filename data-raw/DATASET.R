library(magrittr)

# CLINICAL_EVENTS_FIELD_IDS ---------------------------------------------------------

CLINICAL_EVENTS_FIELD_IDS <- list(
  # for death data, code_fid includes primary and secondary causes
  primary_death_icd10 = c(code_fid = "40001", date_fid = "40000"),
  secondary_death_icd10 = c(code_fid = "40002", date_fid = "40000"),

  self_report_medication = c(code_fid = "20003", date_fid = "53"),

  self_report_non_cancer = c(code_fid = "20002", date_fid = "20008"),
  self_report_non_cancer_icd10 = c(code_fid = "20002", date_fid = "20008"),

  self_report_cancer = c(code_fid = "20001", date_fid = "20006"),

  self_report_operation = c(code_fid = "20004", date_fid = "20010"),

  cancer_register_icd9 = c(code_fid = "40013", date_fid = "40005"),
  cancer_register_icd10 = c(code_fid = "40006", date_fid = "40005"),

  summary_hes_icd9 = c(code_fid = "41271", date_fid = "41281"),
  summary_hes_icd10 = c(code_fid = "41270", date_fid = "41280"),

  summary_hes_opcs3 = c(code_fid = "41273", date_fid = "41283"),
  summary_hes_opcs4 = c(code_fid = "41272", date_fid = "41282")
)

# NONSENSE DATES ----------------------------------------------------------

# make list containing nonsense dates
nonsense_dates_categories <- c(
  "PRIMARY_CARE",
  "MAIN_DATASET"
)

NONSENSE_DATES <- vector(mode = "list", length = length(nonsense_dates_categories))
names(NONSENSE_DATES) <- nonsense_dates_categories

# populate list
NONSENSE_DATES$PRIMARY_CARE <- c("01/01/1901",
                                 "02/02/1902",
                                 "03/03/1903",
                                 "07/07/2037")

# from codings 1313, 272, 586 and 819
NONSENSE_DATES$MAIN_DATASET <- c(
  '1904-04-04',
  '1900-01-01',
  '1910-01-01',
  '1920-01-01',
  '1930-01-01',
  '1901-01-01',
  '1902-02-02',
  '1903-03-03',
  '2037-07-07')

# DUMMY CLINICAL EVENTS DATA ----------------------------------------------

# This is now replaced with `dummy_ukb_main_clinical_events` below

# get dummy ukb data (contains all diagnoses columns) and load single eid for testing
# dummy_ukb_data_path <- download_dummy_ukb_data_to_tempdir()
# dummy_ukb_data_dict <- make_data_dict(ukb_main = dummy_ukb_data_path,
#                                       delim = ",",
#                                       ukb_data_dict = ukb_data_dict)
# dummy_ukb_data_2eid <- read_ukb(path = dummy_ukb_data_path,
#                              delim = ",",
#                              data_dict = dummy_ukb_data_dict %>%
#                                dplyr::filter(FieldID == "eid" |
#                                                (instance %in% c("0", "2") &
#                                                   array %in% c("0", "3") &
#                                                   FieldID %in% as.character(purrr::flatten(CLINICAL_EVENTS_FIELD_IDS)))),
#                              ukb_data_dict = ukb_data_dict,
#                              ukb_codings = ukb_codings,
#                              nrows = 2)

# manually create dummy data for 2 eids (copied from `dummy_ukb_data_2eid`
# above, appended operations & date of death fields. Note also that the dummy
# data generated by tofu (https://github.com/spiros/tofu) formats dates as
# DD/MM/YYYY, whereas UKB formats these as YYYY-MM-DD)
DUMMY_UKB_MAIN_CLINICAL_EVENTS <- data.table::data.table(
  eid = c(1, 2),
  cancer_code_self_reported_f20001_0_0 = c(1048, 1046),
  cancer_code_self_reported_f20001_0_3 = c(1005, 1003),
  cancer_code_self_reported_f20001_2_0 = c(1045, 1028),
  cancer_code_self_reported_f20001_2_3 = c(1017, 1039),

  non_cancer_illness_code_self_reported_f20002_0_0 = c(1665, 1383),
  non_cancer_illness_code_self_reported_f20002_0_3 = c(1223, 1352),
  non_cancer_illness_code_self_reported_f20002_2_0 = c(1514, 1447),
  non_cancer_illness_code_self_reported_f20002_2_3 = c(NA, 1165),

  interpolated_year_when_cancer_first_diagnosed_f20006_0_0 = c(2012.8173, 2016.0638),
  interpolated_year_when_cancer_first_diagnosed_f20006_0_3 = c(2007.0874, 2023.1635),
  interpolated_year_when_cancer_first_diagnosed_f20006_2_0 = c(2023.2047, 2024.0358),
  interpolated_year_when_cancer_first_diagnosed_f20006_2_3 = c(2014.7373, 2013.2044),

  interpolated_year_when_non_cancer_illness_first_diagnosed_f20008_0_0 = c(1998.9782, 2011.0121),
  interpolated_year_when_non_cancer_illness_first_diagnosed_f20008_0_3 = c(2003.1527, 2020.502),
  interpolated_year_when_non_cancer_illness_first_diagnosed_f20008_2_0 = c(2011.2636, 1981.1627),
  interpolated_year_when_non_cancer_illness_first_diagnosed_f20008_2_3 = c(2018.786, 1983.0059),

  diagnoses_icd10_f41270_0_0 = c('X715', 'E11'),
  diagnoses_icd10_f41270_0_3 = c('E10', 'M0087'),
  diagnoses_icd9_f41271_0_0 = c('E89115', 'E8326'),
  diagnoses_icd9_f41271_0_3 = c(NA, '75513'),

  date_of_first_in_patient_diagnosis_icd10_f41280_0_0 = c('1955-11-12', '1939-02-16'),
  date_of_first_in_patient_diagnosis_icd10_f41280_0_3 = c('1910-02-19', '1965-08-08'),
  date_of_first_in_patient_diagnosis_icd9_f41281_0_0 = c('1917-10-08', '1955-02-11'),
  date_of_first_in_patient_diagnosis_icd9_f41281_0_3 = c('1969-11-23', '1956-09-12'),

  underlying_primary_cause_of_death_icd10_f40001_0_0 = c('X095', 'A162'),
  underlying_primary_cause_of_death_icd10_f40001_1_0 = c('X095', 'A162'),
  contributory_secondary_causes_of_death_icd10_f40002_0_0 = c('W192', 'V374'),
  contributory_secondary_causes_of_death_icd10_f40002_1_3 = c('X715', NA),
  date_of_death_f40000_0_0 = c('1917-10-08', '1955-02-11'),
  date_of_death_f40000_1_0 = c('1910-02-19', '1965-08-08'),

  treatment_medication_code_f20003_0_0 = c(1140861958, 1141146234),
  treatment_medication_code_f20003_2_0 = c(1141146188, 1141184722),
  treatment_medication_code_f20003_2_3 = c(1141184722, 1140861958),
  date_of_attending_assessment_centre_f53_0_0 = c('1955-02-11', '1965-08-08'),
  date_of_attending_assessment_centre_f53_2_0 = c('1910-02-19', '1915-03-18'),

  date_of_cancer_diagnosis_f40005_0_0 = c('1956-11-24', '1910-10-04'),
  date_of_cancer_diagnosis_f40005_2_0 = c('1962-09-04', NA),
  type_of_cancer_icd10_f40006_0_0 = c('M4815', NA),
  type_of_cancer_icd10_f40006_2_0 = c('C850', 'W192'),
  type_of_cancer_icd9_f40013_0_0 = c('27134', '9626'),
  type_of_cancer_icd9_f40013_2_0 = c('2042', 'E90200'),

  operative_procedures_opcs4_f41272_0_0 = c('A01', 'A023'),
  operative_procedures_opcs4_f41272_0_3 = c('A018', 'A02'),
  date_of_first_operative_procedure_opcs4_f41282_0_0 = c('1956-11-24', '1910-10-04'),
  date_of_first_operative_procedure_opcs4_f41282_0_3 = c('1969-11-23', '1956-09-12'),
  operative_procedures_opcs3_f41273_0_0 = c('001', '0011'),
  operative_procedures_opcs3_f41273_0_3 = c('0081', '0071'),
  date_of_first_operative_procedure_opcs3_f41283_0_0 = c('1969-11-23', '1956-09-12'),
  date_of_first_operative_procedure_opcs3_f41283_0_3 = c('1955-11-12', '1939-02-16'),

  operation_code_f20004_0_0 = c(1102, 1105),
  operation_code_f20004_0_3 = c(1108, 1109),
  interpolated_year_when_operation_took_place_f20010_0_0 = c(2012.8173, 2016.0638),
  interpolated_year_when_operation_took_place_f20010_0_3 = c(2008.2342, NA)
)


# CLINICAL EVENTS SOURCES --------------------------------------------------

# This relates to the clinical events table generated by the `tidy_clinical_events`

# sources - describe possible values under the `source` column

# "f*" = fieldID with "f" prefix, numerical data_codings are UKB data-codings.
# description and category are copied from the UKB data showcase

# gpc_r2 and gpc_r3 are read2 and 3 codes from the gp_clinical table

CLINICAL_EVENTS_SOURCES <- tibble::tribble(
  ~ source, ~data_coding, ~ description, ~ category, ~ file,
  "f40001", "icd10", "Underlying (primary) cause of death", "Death register", "ukb_main",
  "f40002", "icd10", "Contributory (secondary) cause of death", "Death register", "ukb_main",
  "f20002", "data_coding_6", "Non-cancer illness code, self-reported", "Medical conditions", "ukb_main",
  "f20002_icd10", "icd10", "Non-cancer illness code, self-reported", "Medical conditions", "ukb_main",
  "f20001", "data_coding_3", "Cancer code, self-reported", "Medical conditions", "ukb_main",
  "f20004", "data_coding_5", "Operation code, self-reported", "Operations", "ukb_main",
  "f40013", "icd9", "Type of cancer: ICD9", "Cancer register", "ukb_main",
  "f40006", "icd10", "Type of cancer: ICD10", "Cancer register", "ukb_main",
  "f41270", "icd10", "Diagnoses - ICD10", "Summary Diagnoses - Hospital inpatient - Health-related outcomes", "ukb_main",
  "f41271", "icd9", "Diagnoses - ICD9", "Summary Diagnoses - Hospital inpatient - Health-related outcomes", "ukb_main",
  "f41272", "opcs4", "Operative procedures - OPCS4", "Summary Operations - Hospital inpatient - Health-related outcomes", "ukb_main",
  "f41273", "opcs3", "Operative procedures - OPCS3", "Summary Operations - Hospital inpatient - Health-related outcomes", "ukb_main",
  "f20003", "data_coding_4", "Treatment/medication code, self-reported", "Medications", "ukb_main",

  "gpc1_r2", "read2", "`read_2` column, data provider England (Vision)", "Primary care", "gp_clinical",
  "gpc2_r2", "read2", "`read_2` column, data provider Scotland", "Primary care", "gp_clinical",
  "gpc3_r2", "read2", "`read_2` column, data provider England (TPP)", "Primary care", "gp_clinical",
  "gpc4_r2", "read2", "`read_2` column, data provider Wales", "Primary care", "gp_clinical",
  "gpc1_r3", "read3", "`read_3` column, data provider England (Vision)", "Primary care", "gp_clinical",
  "gpc2_r3", "read3", "`read_3` column, data provider Scotland", "Primary care", "gp_clinical",
  "gpc3_r3", "read3", "`read_3` column, data provider England (TPP)", "Primary care", "gp_clinical",
  "gpc4_r3", "read3", "`read_3` column, data provider Wales", "Primary care", "gp_clinical",

  "gps1_r2", "read2_drugs", "`read_2` column, data provider England (Vision)", "Primary care", "gp_scripts",
  "gps1_dmd", "dmd", "`dmd_code` column, data provider England (Vision)", "Primary care", "gp_scripts",
  "gps2_r2", "read2_drugs", "`read_2` column, data provider Scotland", "Primary care", "gp_scripts",
  "gps2_bnf", "bnf", "`bnf_code` column, data provider Scotland", "Primary care", "gp_scripts",
  "gps3_bnf", "bnf", "`bnf_code` column, data provider England (TPP)", "Primary care", "gp_scripts",
  "gps4_r2", "read2_drugs", "`read_2` column, data provider Wales", "Primary care", "gp_scripts"
)

# SAVE AS R/sysdata.rda -------------------------------------------------------

usethis::use_data(
  # Field ID groups
  CLINICAL_EVENTS_FIELD_IDS,

  # TODO - review these special ukb codings
  # cont_and_int_codings_to_na,
  # cont_and_int_codings_NOT_to_na,

  # nonsense dates
  NONSENSE_DATES,

  # clinical events schema
  CLINICAL_EVENTS_SOURCES,

  # dummy clinical events data
  DUMMY_UKB_MAIN_CLINICAL_EVENTS,

  internal = TRUE,
  overwrite = TRUE
)
