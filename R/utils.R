
# EXPORTED FUNCTIONS ------------------------------------------------------

#' Summarise a dataframe by column type
#'
#' Works with \code{dplyr::group_by()} and the pipe. See the
#' \code{\link[skimr]{skim}} documentation for more details. Adapts the
#' \code{skimr::skim()} function to include proportion counts for factor
#' variables
#'
#' @param data a dataframe
#'
#' @export
my_skim <- skimr::skim_with(
  # factor - a long anonymous function that converts a prop table to a single string
  factor = skimr::sfl(pct = function(x) {
    # make a prop table in %
    pct_table <- prop.table(table(x)) * 100

    # round % to 1dp
    pct_table <- round(pct_table, 1)

    # zip the table names and values together
    combined_vector <- vector(mode = 'character', length = 0L)
    for (i in 1:length(pct_table)) {
      combined_vector <- c(combined_vector, paste0(names(pct_table)[i], ":"))
      combined_vector <- c(combined_vector, paste0(as.character(pct_table)[i], "%,"))
    }

    # see result
    combined_vector

    # glue character vector into single string
    combined_vector <- stringr::str_c(combined_vector, collapse = " ")

    # return result
    return(combined_vector)
  }),

  # logical - returns proportion = TRUE
  logical = skimr::sfl(pct_TRUE = function(x) {sum(x == TRUE, na.rm=TRUE) / length(x) * 100})
)

# PRIVATE FUNCTIONS -------------------------------------------------------

#' Get associated single decriptive colname for a FieldID
#'
#' Use this in functions which manipulate a UKB phenotype dataset processed by
#' \code{\link{read_pheno}}. Should the convention for descriptive column names
#' change then so will these functions, however changes would only need to be
#' updated at the start of each function.
#'
#' @param field_id A UK Biobank Field ID as a string
#' @param ukb_mapping_df a data dictionary generated by
#'   \code{\link{pheno_data_dict}}
#'
#' @return A single descriptive colname as a string
get_colname <- function(
  field_id,
  ukb_mapping_df
  ) {
  ukb_mapping_df %>%
    dplyr::filter(FieldID == field_id) %>%
    .$descriptive_colnames
}


