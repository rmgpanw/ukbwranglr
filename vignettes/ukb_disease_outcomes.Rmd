---
title: 'UKB: Disease outcomes'
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ukbwranglr)
library(tidyverse)
library(readr)
library(configr)

# Constants
config <- read.config("../config.ini")
DUMMY_DATA_PATH <- paste0("../", config$PATHS$DUMMY_DATA_PATH)

# Load data
dummy_data_dict <- ukbwranglr::pheno_data_dict(DUMMY_DATA_PATH, delim = ",")
dummy_ukb_data <- ukbwranglr::read_pheno(DUMMY_DATA_PATH, dummy_data_dict, delim = ",") 
dummy_ukb_data$eid <- as.character(seq(1:nrow(dummy_ukb_data)))
ukb_codings <- data.table::fread(
    "https://biobank.ctsu.ox.ac.uk/~bbdatan/Codings.tsv",
    colClasses = c('character'),
    sep = "\t",
    quote = " ",
    na.strings = c("", "NA")
  )
```

# Overview

Disease outcomes in UKB may be primarily ascertained from the following sources:

- [Self-report data](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100074): [cancer](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20001) and [non-cancer](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20002) 
- [Primary care data](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=3000)
- [Hospital inpatient data](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=2000)
- [Death register records](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100093)

>**Note:** the preceding links for self-report data relate to verbal interview responses. Self-report data also includes [touchscreen](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100025) responses, however UKB [resource 596](https://biobank.ndph.ox.ac.uk/ukb/refer.cgi?id=596) recommends that the verbal interview data fields are used in preference

UKB also provides a set of '[first occurrences](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=1712)' fields, which record the earliest date a 3-character ICD-10 code (e.g. ICD-10 code 'E11' = 'Non-insulin-dependent diabetes mellitus') appears in one of the categories listed above. **Note: this does not include cancer codes, as these are comprehensively captured by the [cancer register data](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100092)**

Other sources to consider include: 

- '[Algorithmically-defined outcomes](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=42)'
- Medication history (e.g. classify participants as having diabetes if they take insulin) - see `vignette("ukb_medications")`

The rest of this article discusses how disease outcomes may be extracted from each of the data sources outlined above.

# Self-report data ([verbal interview](https://biobank.ndph.ox.ac.uk/ukb/label.cgi?id=100074))

## Introduction

FieldID's for self-reported (verbal interview) disease outcomes are categorised into 'non-cancer' and 'cancer':

| Field | Non-cancer | Cancer |
|:------|------------|--------|
| Illness code, self-reported | [20002](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20002) ([data-coding 6](https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=6)) | [20001](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20001) ( [data-coding 3](https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=3))|
| Interpolated year when first diagnosed | [20008](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20008) | [20006](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20006) |
| Interpolated age when first diagnosed | [20009](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20009) | [20007](https://biobank.ndph.ox.ac.uk/ukb/field.cgi?id=20007) |

## Mapping to ICD-10 codes

UK Biobank also provides mappings from self-reported illness codes to 3-character ICD-10 codes ([data-coding 609](https://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=609)). 

>**NOTE:** Not all the self-report codes are mapped to ICD-10 (111 out of 447). For example, the non-cancer illness code `1065` refers to 'hypertension', which cannot be mapped to ICD-10 as it is too non-specific Code `1072`, which refers to 'essential hypertension' however *is* mappable (maps to ICD-10 code `I10`). Code to filter for these codes is shown below:

```{r eval=FALSE}
# get UKB codings dictionary
# (https://biobank.ctsu.ox.ac.uk/crystal/exinfo.cgi?src=accessing_data_guide),
# filtered for coding 609
ukb_codings_609 <-
  readr::read_tsv(
    "https://biobank.ctsu.ox.ac.uk/~bbdatan/Codings.tsv",
    col_types = cols(.default = "c"),
    quote = ""
  ) %>%
  filter(Coding == "609")

# get the full set of UKB self-report non-cancer illness codes form website
# https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=6
html_page <-
  xml2::read_html("https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=6")
table_nodes <- xml2::xml_find_all(html_page, "//table")
ukb_selfreport_non_cancer_codings_readable <-
  rvest::html_table(table_nodes[[2]])

# filter for those that were selectable (i.e. no 'special' values like -1)
ukb_selfreport_non_cancer_codings_readable <-
  ukb_selfreport_non_cancer_codings_readable %>%
  filter(Selectable == "Yes")

# filter for those NOT mapped to ICD-10
ukb_selfreport_non_cancer_codings_readable <-
  ukb_selfreport_non_cancer_codings_readable %>%
  filter(!(Coding %in% ukb_codings_609$Value))

View(ukb_selfreport_codings_readable_no_special_values_not_in_ukb_codings_609)
```

```{r eval=FALSE, include=FALSE}
# ***EXPLORE***

# Note: the ukb codings-file contains all the codes on the webpage for data-coding 609 https://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=609
# get ukbdata-coding 609 (map self-report codes to icd-10 codes)
html_page <- xml2::read_html("https://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=609")
table_nodes <- xml2::xml_find_all(html_page, "//table")
ukb_selfreport_icd_map <- rvest::html_table(table_nodes[[2]])

# ...returns TRUE
all(ukb_codings_609$Value %in% ukb_selfreport_icd_map$Coding)
```

## Identifying disease outcomes by ICD-10 code

- Get FieldID's 20002, 20008 and 20009 separately
- Pivot longer
- row_bind
- join with ICD codes

```{r}
# cols for fieldid 20002
test_self_report <- dummy_ukb_data %>%
  select(eid,
         all_of(
           get_colnames_for_fieldid(field_id = "20002",
                                    data_dict = dummy_data_dict)
         ))

# get UKB codings
f20002_codings <- extract_codings_for_fieldid(field_id = "20002", ukb_data_dict = dummy_data_dict, ukb_codings = ukb_codings)

test <- f20002_codings %>% filter(Value != -1)

length(unique(test$Value))
length(unique(f20002_codings$Value))

# pivot longer - includes extra cols for manual checking
test_self_report_long <- test_self_report %>% 
  pivot_longer(
    cols = all_of(get_colname(field_id = "20002", ukb_mapping_df = dummy_data_dict)),
    # values_drop_na = TRUE
  ) %>% 
  left_join(f20002_codings, by = c("value" = "Meaning"))

# now without extra cols, as function
# self_report_to_icd10 <- function(ukb_pheno,
#                                  field_id,
#                                  data_dict,
#                                  ukb_codings) {
#   
#   # filter ukb_pheno for selected cols (eid + fieldid cols)
#   selected_cols <- get_colname(field_id = field_id,
#                        ukb_mapping_df = data_dict)
#   
#   ukb_pheno <- ukb_pheno %>%
#   select(eid,
#          all_of(selected_cols))
#   
#   # get codings for fieldid
#   field_id_codings <- ukb_codings %>% 
#   filter(Coding == (data_dict %>% 
#                       filter(FieldID == field_id) %>% 
#                       .$Coding %>% 
#                       head(n = 1)))
#   
#   ukb_pheno <- ukb_pheno %>% 
#     pivot_longer(
#       cols = all_of(selected_cols),
#       values_to = paste(paste0("f", field_id), "value", sep = "_")
#     ) %>% 
#     mutate(instance_array = colname_to_field_inst_array_df(name)$instance_array)
#   
#   # rename
#   names(ukb_pheno)[which(names(ukb_pheno) == 'name')] <- paste0("f", field_id)
#   
#   return(ukb_pheno)
# }

test_self_report_long <- field_id_pivot_longer(ukb_pheno = dummy_ukb_data, 
                     field_id = "20002", 
                     data_dict = dummy_data_dict, 
                     ukb_codings = ukb_codings)


test <- recode_ukbcol(df = test_self_report_long, col_to_recode = "f20002_value", field_id = "20002", ukb_data_dict = dummy_data_dict, ukb_codings = ukb_codings, mapping_direction = "meaning_code")

test2 <- recode_ukbcol(df = test_self_report_long, col_to_recode = "f20002_value", field_id = "20002", ukb_data_dict = dummy_data_dict, ukb_codings = ukb_codings, mapping_direction = "meaning_code")

# now multiple field_ids
fields_ids <- c("20002", "20008", "20009")

test <- fields_ids %>% 
  map(field_id_pivot_longer, ukb_pheno = dummy_ukb_data,
                     data_dict = dummy_data_dict, 
                     ukb_codings = ukb_codings) %>% 
  reduce(inner_join, "eid", "instance_array")

  # %>% 
  #   left_join(field_id_codings, by = c("value" = "Meaning")) %>% 
  #   select(eid, coding = Value) %>% 
  #   left_join(self_report_icd_map, by = "coding") %>% 
  #   rename(icd10code = meaning)
```
