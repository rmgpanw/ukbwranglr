---
title: "Misc: UKB codings"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(tidyverse)
library(readr)
library(configr)

# Constants
config <- read.config("../config.ini")
DUMMY_DATA_PATH <- paste0("../", config$PATHS$DUMMY_DATA_PATH)

# Load data
dummy_data_dict <- ukbwranglr::pheno_data_dict(DUMMY_DATA_PATH, delim = ",")
dummy_ukb_data <- ukbwranglr::read_pheno(DUMMY_DATA_PATH, dummy_data_dict, delim = ",") 
dummy_ukb_data$eid <- as.character(seq(1:nrow(dummy_ukb_data)))
ukb_codings <- data.table::fread(
    "https://biobank.ctsu.ox.ac.uk/~bbdatan/Codings.tsv",
    colClasses = c('character'),
    sep = "\t",
    quote = " ",
    na.strings = c("", "NA")
  )

ukb_data_dict <- data.table::fread(
    "https://biobank.ctsu.ox.ac.uk/~bbdatan/Data_Dictionary_Showcase.tsv",
    colClasses = c('character'),
    sep = "\t",
    quote = " ",
    na.strings = c("", "NA")
  )
```

# Overview

Explore UKB codings:

- Categorical codings:

  - Some Codings contain code values with multiple meanings. This has implications for mapping
  - Example: FieldID 20002 (self-reported non-cancer illnesses) has multiple values coded as '-1'. If relabelling these coded values, '-1' will only be converted to a single label. This would also be problematic if attempting to map back to the coded value, for example, if you then wanted to 're-map' from the coded value to ICD-10 codes (see [data-coding 609](https://biobank.ndph.ox.ac.uk/showcase/coding.cgi?id=609)) i.e. meaning -> code -> ICD-10 code
  - For FieldID 20002, I think the '-1' codes can be removed (if they are even present) as none of these were 'selectable' according to the [UKB data showcase website](https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=6) and '-1' is the only code value with multiple asssociated meanings (99999 is also 'not selectable', but only maps to a single meaning "unclassifiable")

# Categorical 

- Number of categorical codings

```{r}
categorical_codings <- ukb_data_dict %>%
  filter(ValueType %in% c("Categorical single", "Categorical multiple")) %>%
  select(ValueType, Coding) %>%
  distinct() %>% 
  arrange(ValueType)

categorical_codings
```

- Number of categorical codings which include values with multiple meanings 

```{r include=FALSE}
categorical_codings_with_multiple_meanings_per_value <-
  ukb_codings %>%
  filter(Coding %in% categorical_codings$Coding) %>%
  group_by(Coding) %>%
  nest() %>%
  mutate(
    has_duplicate_coding_values = map_lgl(data,
                                          ~ n_distinct(.x$Value) < nrow(.x)),
    list_of_troublesome_coding_values = map(
      data,
      ~ .x %>%
        group_by(Value) %>%
        summarise(n = n()) %>%
        filter(n > 1) %>%
        .$Value
    )
  ) %>%
  filter(has_duplicate_coding_values)
```

```{r}
categorical_codings_with_multiple_meanings_per_value
```

- Which FieldIDs use these `r nrow(categorical_codings_with_multiple_meanings_per_value)` codings?

```{r}
ukb_data_dict %>% 
  filter(Coding %in% categorical_codings_with_multiple_meanings_per_value$Coding)
```

>Manually looking at codings 3, 5 and 6 on the UKB data showcase website, I think I can safely remove '-1' values from any mapping procedures (all non-selectable) - it would not be possible to know which 'Meaning' is indicated by '-1' anyway. '99999' was also non-selectable, however it ony maps to a single value, so should not affect mapping procedures.

>Coding 87 refers t0 ICD-9 codes. The only coding value with multiple meanings is 'Chapter V', which has 2 associated meanings:

```{r}
coding_87 <- ukb_codings %>% 
  filter(Coding == 87)

coding_87 %>% 
  group_by(Value) %>% 
  summarise(n = n()) %>% 
  filter(n > 1)

coding_87 %>% 
  filter(Value == "Chapter V")
```
